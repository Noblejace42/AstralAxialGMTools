<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Astral Axial Lifepath</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Inline additional styling for layout and talent UI */
    #main-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
    }
    #game-content {
      flex: 2;
      margin-right: 20px;
    }
    #summary-pane {
      flex: 1;
      background: #262626;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 4px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .talent-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .talent-name {
      flex: 1;
    }
    .talent-controls button {
      margin: 0 5px;
    }
    .lifepath-btn, .event-btn {
      background-color: #444;
      color: #ccc;
      border: 1px solid #555;
      padding: 8px 14px;
      font-size: 1em;
      cursor: pointer;
      border-radius: 4px;
      margin: 5px;
    }
    .lifepath-btn:hover, .event-btn:hover {
      background-color: #555;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">System Generator</a> |
    <a href="lifepath.html">Lifepath Generator</a> |
    <a href="weapongenerator.html">Weapon Generator</a>
  </nav>

  <div id="main-container">
    <div id="game-content"></div>
    <div id="summary-pane">
      <h2>Character Sheet</h2>
      <div id="summary-content"></div>
    </div>
  </div>
<div class="art-credit">
  <a href="https://www.instagram.com/vinny.longbow?igsh=c203czNuMW92MXA3" target="_blank">
    Art Credit: Vincent Fleetwood
  </a>
</div>


  <!-- Main JavaScript -->
  <script>
    // Global variables
    let config;
    let character = {
      age: 15,
      scars: 0,
      lifepaths: [],
      bonds: [],
      items: [],
      talentDecreases: [],
      skills: {
        "Tech": "1d4",
        "Recall": "1d4",
        "Speed": "1d4",
        "Might": "1d4",
        "Charm": "1d4",
        "Fortitude": "1d4",
        "Presence": "1d4",
        "Precision": "1d4",
        "Will": "1d4",
        "Awareness": "1d4"
      }
    };
    let remainingTalentPoints = 0;
    let poolCounts = {}; // will be initialized after loading config

    // Utility functions
    function getRandomElement(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }
    function randomChance() {
      return Math.random();
    }

    // Determine rarity based on base probabilities and lifepath count
    function determineRarity(pool) {
      const base = config.settings.rarityProbabilities;
      let count = poolCounts[pool] || 0;
      let bonus = count * config.settings.rarityProgressionMultiplier;
      let commonProb = base.common - bonus;
      let intermediateProb = base.intermediate + bonus;
      if (commonProb < 0) commonProb = 0;
      let roll = randomChance();
      if (roll < commonProb) return "common";
      else if (roll < commonProb + intermediateProb) return "intermediate";
      else return "expert";
    }

    // Generate lifepath options (3 regular options plus an optional wildcard)
    function generateLifepathOptions() {
      let options = [];
      for (let i = 0; i < 3; i++) {
        let pools = Object.keys(config.lifepathPools);
        let weightedPools = pools.map(p => ({ pool: p, weight: 1 + (poolCounts[p] || 0) }));
        let totalWeight = weightedPools.reduce((sum, p) => sum + p.weight, 0);
        let r = Math.random() * totalWeight;
        let chosenPool;
        for (let wp of weightedPools) {
          r -= wp.weight;
          if (r <= 0) {
            chosenPool = wp.pool;
            break;
          }
        }
        let rarity = determineRarity(chosenPool);
        let jobs = config.lifepathPools[chosenPool].jobs[rarity];
        let job = getRandomElement(jobs);
        options.push({ pool: chosenPool, job: job });
      }
      if (config.settings.wildcardOptionEnabled && randomChance() <= config.settings.wildcardOptionChance) {
        let allPools = Object.keys(config.lifepathPools);
        let randomPool = getRandomElement(allPools);
        let job = getRandomElement(config.lifepathPools[randomPool].jobs["common"]);
        options.push({ pool: randomPool, job: job, wildcard: true });
      }
      return options;
    }

    // Aggregate talents from all lifepaths
    function aggregateTalents() {
      let totals = {};
      character.lifepaths.forEach(lp => {
        for (let talent in lp.talentAllocations) {
          totals[talent] = (totals[talent] || 0) + (lp.talentAllocations[talent] - config.settings.startingTalentLevel);
        }
      });
      for (let talent in totals) {
        totals[talent] = Math.min(config.settings.startingTalentLevel + totals[talent], config.settings.maxTalentLevel);
      }
      return totals;
    }

    // Map talent level to dice
    function levelToDice(level) {
    if (level === 0) return ""; // Hide zero-level talents
    return config.settings.talentDiceMapping[level.toString()] || "";
}


    // Update the character sheet summary pane
    function updateSummary() {
      const summaryDiv = document.getElementById("summary-content");
      let html = `<div class="summary-section" style="background:#333; padding:5px; margin-bottom:5px;">
                    <h3>General</h3>
                    <p><strong>Age:</strong> ${character.age}</p>
                    <p><strong>Scars:</strong> ${character.scars}</p>
                    <p><strong>Bonds:</strong> ${character.bonds.join("; ") || "None"}</p>
                    <p><strong>Items:</strong> ${character.items.join("; ") || "None"}</p>
                  </div>`;
      html += `<div class="summary-section" style="background:#2a2a2a; padding:5px; margin-bottom:5px;">
                 <h3>Skills</h3>
                 <ul>`;
      for (let skill in character.skills) {
        html += `<li>${skill}: ${character.skills[skill]}</li>`;
      }
      html += `</ul></div>`;
      const aggregatedTalents = aggregateTalents();
      html += `<div class="summary-section" style="background:#222; padding:5px; margin-bottom:5px;">
                 <h3>Talents</h3>
                 <ul>`;
      for (let talent in aggregatedTalents) {
        html += `<li>${talent}: ${levelToDice(aggregatedTalents[talent])} (Level ${aggregatedTalents[talent]})</li>`;
      }
      html += `</ul></div>`;
      let eventsTaken = character.lifepaths.map(lp => lp.event).filter(ev => ev).join("; ");
      html += `<div class="summary-section" style="background:#1e1e1e; padding:5px;">
                 <h3>Events</h3>
                 <p>${eventsTaken || "None"}</p>
               </div>`;
      summaryDiv.innerHTML = html;
    }

    // Display lifepath selection options
    function showInitialPoolSelection() {
      const contentDiv = document.getElementById("game-content");
      contentDiv.innerHTML = "<h2>Select a Lifepath Option</h2>";
      let options = generateLifepathOptions();
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.classList.add("lifepath-btn");
        let label = `${opt.job.name} (${opt.pool})`;
        if (opt.wildcard) label += " [Wildcard]";
        btn.textContent = label;
        btn.onclick = function() {
          selectLifepath(opt.pool, opt.job);
        };
        contentDiv.appendChild(btn);
      });
      updateSummary();
    }

    // Process lifepath selection
    function selectLifepath(pool, job) {
      poolCounts[pool] = (poolCounts[pool] || 0) + 1;
      const newLP = { pool: pool, job: job, talentAllocations: {}, event: null, agingMessage: "" };
      character.lifepaths.push(newLP);
      character.age += 5;
      remainingTalentPoints = job.talentPoints;
      showTalentAllocation(newLP);
      updateSummary();
    }

    // Display talent allocation UI for the selected lifepath
    function showTalentAllocation(lp) {
      const contentDiv = document.getElementById("game-content");
      contentDiv.innerHTML = `<h2>Talent Allocation for ${lp.job.name}</h2>
                              <p>Remaining Points: <span id="remaining-points">${remainingTalentPoints}</span></p>
                              <div id="talent-allocation-container"></div>
                              <button id="talent-confirm-btn" class="lifepath-btn">Confirm Allocation</button>`;
      // Determine available talents: guaranteed, random slots from pool, plus one extra from extraPool
      let talentOptions = [].concat(lp.job.guaranteed);
      let poolTalents = config.lifepathPools[lp.pool].talents;
      for (let i = 0; i < lp.job.randomSlots; i++) {
        let rand = getRandomElement(poolTalents);
        while (talentOptions.includes(rand)) {
          rand = getRandomElement(poolTalents);
        }
        talentOptions.push(rand);
      }
      let extraPoolTalents = config.lifepathPools[lp.job.extraPool].talents;
      let extra = getRandomElement(extraPoolTalents);
      while (talentOptions.includes(extra)) {
        extra = getRandomElement(extraPoolTalents);
      }
      talentOptions.push(extra);
      // Initialize talents to starting level
      // Initialize talents at 0 (hidden until increased)
talentOptions.forEach(talent => {
    lp.talentAllocations[talent] = 0;
});

      // Render UI controls for each talent
      const container = document.getElementById("talent-allocation-container");
      container.innerHTML = "";
      talentOptions.forEach(talent => {
        const row = document.createElement("div");
        row.className = "talent-row";
        const nameSpan = document.createElement("span");
        nameSpan.className = "talent-name";
        nameSpan.textContent = talent;
        row.appendChild(nameSpan);
        const controls = document.createElement("div");
        controls.className = "talent-controls";
        const downBtn = document.createElement("button");
        downBtn.textContent = "▼";
        downBtn.onclick = function() {
          if (lp.talentAllocations[talent] > config.settings.startingTalentLevel) {
            lp.talentAllocations[talent]--;
            remainingTalentPoints++;
            updateTalentUI(lp);
          }
        };
        controls.appendChild(downBtn);
        const levelSpan = document.createElement("span");
        levelSpan.id = "talent-" + talent.replace(/\s+/g, '');
        levelSpan.textContent = lp.talentAllocations[talent];
        controls.appendChild(levelSpan);
        const upBtn = document.createElement("button");
        upBtn.textContent = "▲";
        upBtn.onclick = function() {
          if (lp.talentAllocations[talent] < config.settings.maxTalentLevel && remainingTalentPoints > 0) {
            lp.talentAllocations[talent]++;
            remainingTalentPoints--;
            updateTalentUI(lp);
          }
        };
        controls.appendChild(upBtn);
        row.appendChild(controls);
        container.appendChild(row);
      });
      document.getElementById("talent-confirm-btn").onclick = function() {
        showEventOptions(lp.pool);
      };
      updateSummary();
    }

    // Update the talent allocation UI after changes
    function updateTalentUI(lp) {
      for (let talent in lp.talentAllocations) {
        const id = "talent-" + talent.replace(/\s+/g, '');
const span = document.getElementById(id);
if (span) {
    if (lp.talentAllocations[talent] === 0) {
        span.parentElement.style.display = "none"; // Hide talents with 0 points
    } else {
        span.parentElement.style.display = "flex"; // Show talents that have points
        span.textContent = lp.talentAllocations[talent];
    }
}

      }
      document.getElementById("remaining-points").textContent = remainingTalentPoints;
      updateSummary();
    }

    // Display event options for the selected lifepath's pool
    function showEventOptions(pool) {
      const contentDiv = document.getElementById("game-content");
      contentDiv.innerHTML = `<h2>${pool} Event Options</h2>`;
      const eventsArr = config.events[pool];
      eventsArr.forEach(ev => {
        const btn = document.createElement("button");
        btn.classList.add("event-btn");
        btn.textContent = ev;
        btn.onclick = function() {
          selectEvent(ev, pool);
        };
        contentDiv.appendChild(btn);
      });
      updateSummary();
    }

    // Process event selection and update character accordingly
    function selectEvent(eventName, pool) {
      const lp = character.lifepaths[character.lifepaths.length - 1];
      lp.event = eventName;
      const contentDiv = document.getElementById("game-content");
      const resultDiv = document.createElement("div");
      resultDiv.innerHTML = `<p><strong>Event Result:</strong> ${eventName}result</p>`;
      contentDiv.appendChild(resultDiv);
      character.bonds.push(`${pool} Bond from ${eventName}`);
      character.items.push(`${pool} Item from ${eventName}`);
      lp.agingMessage = checkAgingPenalties();
      askContinue();
      updateSummary();
    }

    // Apply aging penalties based on character age
    function checkAgingPenalties() {
      let messages = [];
      const penalties = [
        { age: 30, chance: 1/8 },
        { age: 40, chance: 1/6 },
        { age: 50, chance: 1/4 },
        { age: 55, chance: 1/4 },
        { age: 60, chance: 1/4 },
        { age: 65, chance: 1/4, decreases: 2 }
      ];
      penalties.forEach(penalty => {
        if (character.age >= penalty.age && randomChance() < penalty.chance) {
          character.scars++;
if (character.scars > 5) {
    displayDeathScreen();
    return "You died.";
}
          let decreaseCount = penalty.decreases || 1;
          let lp = character.lifepaths[character.lifepaths.length - 1];
          let available = Object.keys(lp.talentAllocations).filter(t => lp.talentAllocations[t] > config.settings.startingTalentLevel);
          let decreased = [];
          for (let i = 0; i < decreaseCount && available.length > 0; i++) {
            let chosen = getRandomElement(available);
            lp.talentAllocations[chosen]--;
            decreased.push(chosen);
            available = Object.keys(lp.talentAllocations).filter(t => lp.talentAllocations[t] > config.settings.startingTalentLevel);
          }
          messages.push(`Gained a scar; decreased: ${decreased.join(", ")}`);
        }
      });
      if (messages.length === 0) messages.push("Aged without issue");
      return messages.join(" | ");
    }

    // Ask the player if they want to continue with another lifepath or finish
    function askContinue() {
      const contentDiv = document.getElementById("game-content");
      const div = document.createElement("div");
      div.innerHTML = `<h2>Current Age: ${character.age}</h2>
                       <p>Do you want to take another lifepath? (Each adds 5 years)</p>`;
      const contBtn = document.createElement("button");
      contBtn.classList.add("lifepath-btn");
      contBtn.textContent = "Continue Lifepath";
      contBtn.onclick = function() {
        showInitialPoolSelection();
      };
      div.appendChild(contBtn);
      const finishBtn = document.createElement("button");
      finishBtn.classList.add("lifepath-btn");
      finishBtn.textContent = "Finish Lifepath Creation";
      finishBtn.onclick = function() {
        displayFinalSummary();
      };
      div.appendChild(finishBtn);
      contentDiv.appendChild(div);
      updateSummary();
    }

    function displayDeathScreen() {
    const contentDiv = document.getElementById("game-content");
    contentDiv.innerHTML = `<h2>You Died</h2>
                            <p>Your character has succumbed to their injuries.</p>
                            <button class="lifepath-btn" onclick="restartGame()">Restart</button>`;
}

    function restartGame() {
    character = {
        age: 15,
        scars: 0,
        lifepaths: [],
        bonds: [],
        items: [],
        talentDecreases: [],
        skills: {
            "Tech": "1d4", "Recall": "1d4", "Speed": "1d4", "Might": "1d4",
            "Charm": "1d4", "Fortitude": "1d4", "Presence": "1d4", "Precision": "1d4",
            "Will": "1d4", "Awareness": "1d4"
        }
    };
    poolCounts = {};
    showInitialPoolSelection();
}
    
    // Display the final character sheet summary
    function displayFinalSummary() {
      const contentDiv = document.getElementById("game-content");
      let html = `<h2>Final Character Sheet</h2>
                  <div class="summary-section" style="background:#333; padding:5px; margin-bottom:5px;">
                    <h3>General</h3>
                    <p><strong>Age:</strong> ${character.age}</p>
                    <p><strong>Scars:</strong> ${character.scars}</p>
                    <p><strong>Bonds:</strong> ${character.bonds.join("; ") || "None"}</p>
                    <p><strong>Items:</strong> ${character.items.join("; ") || "None"}</p>
                  </div>
                  <div class="summary-section" style="background:#2a2a2a; padding:5px; margin-bottom:5px;">
                    <h3>Skills</h3>
                    <ul>`;
      for (let skill in character.skills) {
        html += `<li>${skill}: ${character.skills[skill]}</li>`;
      }
      html += `</ul></div>`;
      const aggregatedTalents = aggregateTalents();
      html += `<div class="summary-section" style="background:#222; padding:5px; margin-bottom:5px;">
               <h3>Aggregated Talents</h3>
               <ul>`;
      for (let talent in aggregatedTalents) {
        html += `<li>${talent}: ${levelToDice(aggregatedTalents[talent])} (Level ${aggregatedTalents[talent]})</li>`;
      }
      html += `</ul></div>`;
      let eventsTaken = character.lifepaths.map(lp => lp.event).filter(ev => ev).join("; ");
      html += `<div class="summary-section" style="background:#1e1e1e; padding:5px;">
               <h3>Events</h3>
               <p>${eventsTaken || "None"}</p>
               </div>`;
      contentDiv.innerHTML = html;
      updateSummary();
    }

    // Load external JSON configuration from lifepath_data.json
    document.addEventListener("DOMContentLoaded", function() {
      fetch("lifepath_data.json")
        .then(response => response.json())
        .then(data => {
          config = data;
          // Initialize lifepath pool counts
          Object.keys(config.lifepathPools).forEach(pool => {
            poolCounts[pool] = 0;
          });
          showInitialPoolSelection();
        })
        .catch(error => {
          console.error("Error loading lifepath_data.json:", error);
        });
    });
  </script>
</body>
</html>
