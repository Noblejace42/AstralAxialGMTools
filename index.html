<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Astral Axial System Generator</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <nav>
    <a href="index.html">System Generator</a> |
    <a href="lifepath.html">Lifepath Generator</a> |
    <a href="weapongenerator.html">Weapon Generator</a> |
    <a href="combat_tracker.html">Combat Tracker</a>
  </nav>

  <div class="container">
    <h1>Astral Axial System Generator</h1>

    <!-- Generate button now placed below the title card -->
    <div class="button-bar">
      <button id="generateSystemButton" class="btn-system">
        Generate System
      </button>
    </div>

    <!-- Main output container where the system and settlements will be rendered -->
    <div id="systemOutput"></div>

    <!-- Advanced options panel (hidden for now) -->
    <div id="advancedOptions" style="display: none;">
      <h2>Advanced Settings</h2>
      <!-- Future dynamic UI elements can be injected here -->
    </div>
  </div>

  <div class="art-credit">
    <a href="https://www.instagram.com/vinny.longbow?igsh=c203czNuMW92MXA3" target="_blank">
      Art Credit: Vincent Fleetwood
    </a>
  </div>

  <script>
    /* Global variables to hold the configuration and generated system data.
       Ensure systemgeneratorinfo.json is in the same folder, or update the fetch path accordingly.
    */
    let config = null;
    let systemData = null;

    // --------------------
    // Utility Functions
    // --------------------
    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function weightedRandom(choices) {
      const totalWeight = choices.reduce((sum, choice) => sum + choice.weight, 0);
      let randomNum = Math.random() * totalWeight;
      for (const choice of choices) {
        if (randomNum < choice.weight) {
          return choice.value !== undefined ? choice.value : choice.name;
        }
        randomNum -= choice.weight;
      }
    }

    function toRoman(num) {
      const romans = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
      return romans[num - 1] || num;
    }

    // --------------------
    // Fetch Configuration
    // --------------------
    async function loadConfig() {
      try {
        const response = await fetch('systemgeneratorinfo.json');
        config = await response.json();
        console.log('Config loaded:', config);
      } catch (error) {
        console.error('Failed to load config:', error);
      }
    }

    // --------------------
    // System Generation
    // --------------------
    function generateSystemCode() {
      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const digits = "0123456789";
      let code = "";
      code += letters.charAt(randomInt(0, letters.length - 1));
      code += letters.charAt(randomInt(0, letters.length - 1));
      code += digits.charAt(randomInt(0, digits.length - 1));
      code += digits.charAt(randomInt(0, digits.length - 1));
      code += letters.charAt(randomInt(0, letters.length - 1));
      code += digits.charAt(randomInt(0, digits.length - 1));
      return code;
    }

    function generateSystem() {
      let code = generateSystemCode();
      let prefix = weightedRandom(config.system.nameComponents.prefix);
      let core = weightedRandom(config.system.nameComponents.core);
      let systemDesignation = prefix + core;
      let systemName = code + " " + systemDesignation;

      const planetCountRange = config.system.planetCountRange || { min: 0, max: 6 };
      let numPlanets = randomInt(planetCountRange.min, planetCountRange.max);
      let planets = [];
      if (numPlanets > 0) {
        for (let i = 1; i <= numPlanets; i++) {
          let planetType = weightedRandom(config.planet.types);
          let biome = config.planet.conditions[randomInt(0, config.planet.conditions.length - 1)];
          let planetName = systemDesignation + " " + toRoman(i);
          let planet = {
            name: planetName,
            biome: biome,
            type: planetType,
            settlements: []
          };
          let settlementCount = randomInt(1, 4);
          for (let j = 0; j < settlementCount; j++) {
            planet.settlements.push(generateSettlementData(false, planetType));
          }
          planets.push(planet);
        }
      }
      let settlements = [];
      if (numPlanets === 0) {
        settlements.push(generateSettlementData(true));
      }
      let sysConditions = config.system.conditions.sort(() => Math.random() - 0.5)
                        .slice(0, randomInt(0, 3));
      systemData = {
        systemName: systemName,
        planets: planets,
        settlements: numPlanets === 0 ? settlements : null,
        sysConditions: sysConditions
      };
      renderSystem();
    }

    // --------------------
    // Settlement Generation
    // --------------------
    function generateSettlementData(forceType = false, planetModifier = null) {
      let settlementType;
      if (forceType) {
        settlementType = config.settlement.types.station;
      } else {
        const types = Object.values(config.settlement.types);
        settlementType = types[randomInt(0, types.length - 1)];
        if (settlementType.forceType) forceType = true;
      }
      let prefix = weightedRandom(config.names.settlementPrefix);
      let core = weightedRandom(config.names.settlementCore);
      let suffix = (forceType && settlementType.forceType) ? settlementType.name : weightedRandom(config.names.settlementSuffix);
      let name = prefix + core + " " + suffix;

      let militarism = randomInt(config.settlement.coreStats.militarism.base.min, config.settlement.coreStats.militarism.base.max);
      let prosperity = randomInt(config.settlement.coreStats.prosperity.base.min, config.settlement.coreStats.prosperity.base.max);
      let stability = randomInt(config.settlement.coreStats.stability.base.min, config.settlement.coreStats.stability.base.max);
      if (planetModifier && planetModifier.modifiers) {
        militarism += planetModifier.modifiers.militarism || 0;
        prosperity += planetModifier.modifiers.prosperity || 0;
        stability += planetModifier.modifiers.stability || 0;
      }
      militarism = Math.max(0, Math.min(militarism, 150));
      prosperity = Math.max(0, Math.min(prosperity, 150));
      stability = Math.max(0, Math.min(stability, 150));

      let popMax = Math.floor((prosperity / 100) * config.globalSettings.defaultRanges.population.max * settlementType.populationMultiplier);
      if (settlementType.name === "Station" && Math.random() < 0.95) {
        popMax = Math.min(popMax, 200);
      }
      popMax = Math.max(popMax, config.globalSettings.defaultRanges.population.min);
      let population = randomInt(config.globalSettings.defaultRanges.population.min, popMax);

      let government = weightedRandom(config.settlement.government.types);
      let rulerTitle = weightedRandom(config.settlement.government.rulerTitles);
      let firstName = weightedRandom(config.names.firstNamePrefixes) + weightedRandom(config.names.firstNameSuffixes);
      let lastName = weightedRandom(config.names.lastNamePrefixes) + weightedRandom(config.names.lastNameSuffixes);
      let importantFigure = rulerTitle + " " + firstName + " " + lastName;

      let exportsPool = [];
      if (prosperity < 40) {
        exportsPool = config.settlement.attributes.exports.lowProsperity;
      } else if (prosperity < 70) {
        exportsPool = config.settlement.attributes.exports.mediumProsperity;
      } else {
        exportsPool = config.settlement.attributes.exports.highProsperity;
      }
      let expCount = randomInt(1, 5);
      let exportsGenerated = exportsPool.sort(() => Math.random() - 0.5).slice(0, expCount);

      let poiPool = [];
      if (prosperity < 40) {
        poiPool = config.settlement.attributes.pointsOfInterest.lowProsperity;
      } else if (prosperity < 70) {
        poiPool = config.settlement.attributes.pointsOfInterest.mediumProsperity;
      } else {
        poiPool = config.settlement.attributes.pointsOfInterest.highProsperity;
      }
      let poiCount = randomInt(1, poiPool.length);
      let poi = poiPool.sort(() => Math.random() - 0.5).slice(0, poiCount);

      let conds = config.settlement.conditions.settlement.sort(() => Math.random() - 0.5)
                    .slice(0, randomInt(0, 3));

      let military = generateMilitaryData(population, militarism, forceType);

      let baseStructCount = randomInt(config.settlement.military.structures.minCount, config.settlement.military.structures.maxCount);
      if (militarism > 70) baseStructCount += 2;
      else if (militarism < 40) baseStructCount = Math.max(1, baseStructCount - 1);
      let militaryStructures = [];
      let structuresList = config.settlement.military.structures.structureList;
      for (let i = 0; i < baseStructCount; i++) {
        militaryStructures.push(structuresList[randomInt(0, structuresList.length - 1)]);
      }

      let traderMin = config.settlement.traders.defaultCountRange.min;
      let traderMax = config.settlement.traders.defaultCountRange.max;
      if (stability < 40) traderMax = Math.max(traderMin, traderMax - 1);
      else if (stability > 70) traderMax = Math.min(6, traderMax + 1);
      let traderCount = randomInt(traderMin, traderMax);
      let traders = [];
      let tradedMaterialsPool = [];
      if (prosperity < 40) {
        tradedMaterialsPool = config.extensions.traders.configuration.attributes.tradedMaterial.lowProsperity;
      } else if (prosperity < 70) {
        tradedMaterialsPool = config.extensions.traders.configuration.attributes.tradedMaterial.mediumProsperity;
      } else {
        tradedMaterialsPool = config.extensions.traders.configuration.attributes.tradedMaterial.highProsperity;
      }
      for (let i = 0; i < traderCount; i++) {
        let captainFirstName = weightedRandom(config.names.firstNamePrefixes) + weightedRandom(config.names.firstNameSuffixes);
        let captainLastName = weightedRandom(config.names.lastNamePrefixes) + weightedRandom(config.names.lastNameSuffixes);
        let captainName = captainFirstName + " " + captainLastName;
        let tradedMaterial = tradedMaterialsPool[randomInt(0, tradedMaterialsPool.length - 1)];
        traders.push({ captainName, tradedMaterial });
      }

      return {
        name,
        population,
        government,
        importantFigure,
        coreStats: { militarism, prosperity, stability },
        exports: exportsGenerated,
        conditions: conds,
        pointsOfInterest: poi,
        military: military,
        militaryStructures: militaryStructures,
        traders: traders,
        settlementType: settlementType.name
      };
    }

    function generateMilitaryData(population, militarism, forcedStation) {
      let basePerc = randomInt(
        config.settlement.military.assets.soldiers.populationPercentage.min * 100,
        config.settlement.military.assets.soldiers.populationPercentage.max * 100
      ) / 100;
      let soldierMultiplier = militarism / 50;
      let soldiers = Math.floor(population * basePerc * soldierMultiplier);
      soldiers = Math.min(soldiers, population);

      let vehiclesRatio = randomInt(
        config.settlement.military.assets.armoredVehicles.soldiersPerVehicle.min,
        config.settlement.military.assets.armoredVehicles.soldiersPerVehicle.max
      );
      let armoredVehicles = Math.max(1, Math.floor(soldiers / vehiclesRatio));

      let ships = {};
      if (config.settlement.military.assets.ships.enabled) {
        let totalShips = 0;
        if (forcedStation) {
          totalShips = randomInt(
            config.settlement.military.assets.ships.forcedStationMinimum.min,
            config.settlement.military.assets.ships.forcedStationMinimum.max
          );
        } else if (population >= config.settlement.military.assets.ships.defaultMinimumPopulation) {
          totalShips = randomInt(
            config.settlement.military.assets.ships.defaultShipCountRange.min,
            config.settlement.military.assets.ships.defaultShipCountRange.max
          );
        }
        config.settlement.military.assets.ships.shipTypes.forEach(shipType => {
          ships[shipType.name] = 0;
        });
        for (let i = 0; i < totalShips; i++) {
          let chosenType = weightedRandom(config.settlement.military.assets.ships.shipTypes);
          ships[chosenType.name] += 1;
        }
      }
      return { soldiers, armoredVehicles, ships };
    }

    // --------------------
    // Rendering
    // --------------------
    function renderSettlement(settlement, planetIndex, settlementIndex) {
      let shipStr = "";
      if (settlement.military.ships) {
        for (let type in settlement.military.ships) {
          if (settlement.military.ships[type] > 0) {
            shipStr += `${type} x${settlement.military.ships[type]} `;
          }
        }
      }
      if (shipStr === "") shipStr = "None";

      // Produce more condensed output using inline separators.
      let tradersHtml = "";
      if (settlement.traders && settlement.traders.length > 0) {
        tradersHtml = `<ul class="inline-list">`;
        settlement.traders.forEach(trader => {
          tradersHtml += `<li>${trader.captainName} (${trader.tradedMaterial})</li>`;
        });
        tradersHtml += `</ul>`;
      }
      let militaryStructuresHtml = "";
      if (settlement.militaryStructures && settlement.militaryStructures.length > 0) {
        militaryStructuresHtml = `<ul class="inline-list">`;
        settlement.militaryStructures.forEach(structure => {
          militaryStructuresHtml += `<li>${structure}</li>`;
        });
        militaryStructuresHtml += `</ul>`;
      }

      return `
      <div class="settlement" id="settlement-${planetIndex}-${settlementIndex}">
        <div class="settlement-output">
          <strong>${settlement.name}</strong> | 
          <span>${settlement.settlementType}</span> | 
          <span>Pop: ${settlement.population}</span> | 
          <span>Gov: ${settlement.government}</span> | 
          <span>Fig: ${settlement.importantFigure}</span> | 
          <span>Stats: M:${settlement.coreStats.militarism}, P:${settlement.coreStats.prosperity}, S:${settlement.coreStats.stability}</span> | 
          <span>Exports: ${settlement.exports.join(", ") || "None"}</span> | 
          <span>POI: ${settlement.pointsOfInterest.join(", ") || "None"}</span> | 
          <span>Conds: ${settlement.conditions.join(", ") || "None"}</span> | 
          <span>Military: S:${settlement.military.soldiers}, AV:${settlement.military.armoredVehicles}, Ships: ${shipStr}</span> | 
          <span>Structs: ${militaryStructuresHtml || "None"}</span> | 
          <span>Traders: ${tradersHtml || "None"}</span>
        </div>
        <button onclick="regenerateSettlement(${planetIndex}, ${settlementIndex})" class="${config.ui.elements.regenerateButton.class}">
          ${config.ui.elements.regenerateButton.label}
        </button>
      </div>`;
    }

    function renderSystem() {
      const outputDiv = document.getElementById("systemOutput");
      let totalSettlements = systemData.planets.length > 0
          ? systemData.planets.reduce((sum, p) => sum + p.settlements.length, 0)
          : systemData.settlements.length;

      let html = `<div class="section">
        <h2>System: ${systemData.systemName}</h2>
        <p><strong>System Conditions:</strong> ${systemData.sysConditions.join(", ") || "None"}</p>
        <p><strong>Planets:</strong> ${systemData.planets.length}</p>
        <p><strong>Total Settlements:</strong> ${totalSettlements}</p>
      </div>`;

      if (systemData.planets.length > 0) {
        systemData.planets.forEach((planet, pIndex) => {
          html += `<div class="section planet">
            <h3>Planet: ${planet.name}</h3>
            <p><strong>Biome:</strong> ${planet.biome} (${planet.type ? planet.type.name : "Unknown"})</p>`;
          if (planet.settlements.length > 0) {
            planet.settlements.forEach((settlement, sIndex) => {
              html += renderSettlement(settlement, pIndex, sIndex);
            });
          } else {
            html += `<p>No settlements on this planet.</p>`;
          }
          html += `</div>`;
        });
      } else {
        html += `<div class="section">
          <h3>Settlement (Space Station):</h3>
          ${renderSettlement(systemData.settlements[0], 0, 0)}
        </div>`;
      }
      outputDiv.innerHTML = html;
    }

    function regenerateSettlement(planetIndex, settlementIndex) {
      if (systemData.planets && systemData.planets.length > 0) {
        let planet = systemData.planets[planetIndex];
        planet.settlements[settlementIndex] = generateSettlementData(false, planet.type);
        renderSystem();
      } else {
        systemData.settlements[settlementIndex] = generateSettlementData(true);
        renderSystem();
      }
    }

    // --------------------
    // Event Listeners
    // --------------------
    document.getElementById("generateSystemButton").addEventListener("click", generateSystem);
    loadConfig().then(() => {
      // Optionally auto-generate a system on load:
      // generateSystem();
    });
  </script>
</body>
</html>
