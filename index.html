<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Astral Axial System Generator</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <nav>
    <a href="index.html">System Generator</a> |
    <a href="lifepath.html">Lifepath Generator</a> |
    <a href="weapongenerator.html">Weapon Generator</a> |
    <a href="combat_tracker.html">Combat Tracker</a>
  </nav>

  <div class="container">
    <h1>Astral Axial System Generator</h1>

    <div class="button-bar">
      <button id="generateSystemButton" class="btn-system">
        Generate System
      </button>
    </div>

    <div id="systemOutput"></div>

    <div id="advancedOptions" style="display: none;">
      <h2>Advanced Settings</h2>
      <!-- Future dynamic UI elements can be added here -->
    </div>
  </div>

  <div class="art-credit">
    <a href="https://www.instagram.com/vinny.longbow?igsh=c203czNuMW92MXA3" target="_blank">
      Art Credit: Vincent Fleetwood
    </a>
  </div>

  <script>
    // Global config & system data
    let config = null;
    let systemData = null;

    // --------------------
    // Weighted Random Helpers
    // --------------------
    function weightedRandomBaseWeight(choices) {
      /* This version of weightedRandom looks for "baseWeight" 
         instead of "weight" so it works with government/ruler data. */
      let total = 0;
      for (const choice of choices) {
        total += choice.baseWeight;
      }
      let randomNum = Math.random() * total;
      for (const choice of choices) {
        if (randomNum < choice.baseWeight) {
          return choice;
        }
        randomNum -= choice.baseWeight;
      }
      return choices[choices.length - 1]; // fallback
    }

    function weightedRandom(choices) {
      /* For data that uses "weight" property. 
         (Currently, your JSON for planet types or settlement prefixes uses "weight", 
          but government uses "baseWeight".) */
      let total = 0;
      for (const choice of choices) {
        total += (choice.weight || 1);
      }
      let randomNum = Math.random() * total;
      for (const choice of choices) {
        let w = (choice.weight || 1);
        if (randomNum < w) {
          return choice;
        }
        randomNum -= w;
      }
      return choices[choices.length - 1];
    }

    // Basic integer random
    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Convert 1..10 to Roman
    function toRoman(num) {
      const romans = ["I","II","III","IV","V","VI","VII","VIII","IX","X"];
      return romans[num - 1] || num;
    }

    // --------------------
    // Load the JSON config
    // --------------------
    async function loadConfig() {
      try {
        const resp = await fetch("systemgeneratorinfo.json");
        config = await resp.json();
        console.log("Config loaded:", config);
      } catch(e) {
        console.error("Error loading config:", e);
      }
    }

    // --------------------
    // System Generation
    // --------------------
    function generateSystemCode() {
      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const digits = "0123456789";
      let code = "";
      code += letters.charAt(randomInt(0, letters.length - 1));
      code += letters.charAt(randomInt(0, letters.length - 1));
      code += digits.charAt(randomInt(0, digits.length - 1));
      code += digits.charAt(randomInt(0, digits.length - 1));
      code += letters.charAt(randomInt(0, letters.length - 1));
      code += digits.charAt(randomInt(0, digits.length - 1));
      return code;
    }

    function generateSystem() {
      let code = generateSystemCode();
      let prefix = weightedRandom(config.system.nameComponents.prefix);
      let core = weightedRandom(config.system.nameComponents.core);
      let sysDesignation = prefix.name + core.name;
      let systemName = code + " " + sysDesignation;

      // planet count
      const planetRange = config.system.planetCountRange || { min:0, max:6 };
      let planetCount = randomInt(planetRange.min, planetRange.max);
      let planets = [];
      if (planetCount > 0) {
        for (let i=1; i<=planetCount; i++){
          let planetType = weightedRandom(config.planet.types);
          let biome = config.planet.conditions[randomInt(0, config.planet.conditions.length - 1)];
          let planetName = sysDesignation + " " + toRoman(i);

          let planet = {
            name: planetName,
            biome: biome,
            type: planetType,
            settlements: []
          };
          // each planet gets 1-4 settlements
          let settlementCount = randomInt(1,4);
          for (let j=0; j<settlementCount; j++){
            planet.settlements.push( generateSettlementData(false, planetType) );
          }
          planets.push(planet);
        }
      }

      let settlements = [];
      if (planetCount === 0) {
        // if no planets, we create a single forced station
        settlements.push( generateSettlementData(true) );
      }

      let sysConditions = [...config.system.conditions];
      sysConditions.sort(() => Math.random() - 0.5);
      sysConditions = sysConditions.slice(0, randomInt(0,3));

      systemData = {
        systemName,
        planets,
        settlements: planetCount === 0 ? settlements : null,
        sysConditions
      };
      renderSystem();
    }

    // --------------------
    // Settlement Generation
    // --------------------
    function generateSettlementData(forceStation=false, planetType=null) {
      // pick settlement type
      let settlementType;
      if (forceStation) {
        settlementType = config.settlement.types.station;
      } else {
        const stTypes = Object.values(config.settlement.types);
        settlementType = stTypes[randomInt(0, stTypes.length-1)];
        if (settlementType.forceType) {
          forceStation = true;
        }
      }

      // Name generation
      let prefix = weightedRandom(config.names.settlementPrefix);
      let core = weightedRandom(config.names.settlementCore);
      let suffix = (forceStation && settlementType.forceType)
                   ? settlementType.name
                   : weightedRandom(config.names.settlementSuffix);
      let settlementName = prefix.name + core.name + " " + suffix.name;

      // generate stats
      let mil = randomInt(
        config.settlement.coreStats.militarism.base.min,
        config.settlement.coreStats.militarism.base.max
      );
      let pro = randomInt(
        config.settlement.coreStats.prosperity.base.min,
        config.settlement.coreStats.prosperity.base.max
      );
      let sta = randomInt(
        config.settlement.coreStats.stability.base.min,
        config.settlement.coreStats.stability.base.max
      );

      // apply planet modifiers
      if (planetType && planetType.modifiers) {
        mil += planetType.modifiers.militarism || 0;
        pro += planetType.modifiers.prosperity || 0;
        sta += planetType.modifiers.stability || 0;
      }
      // apply type modifiers
      mil += settlementType.modifiers.militarism;
      pro += settlementType.modifiers.prosperity;
      sta += settlementType.modifiers.stability;

      // clamp
      mil = Math.max(0, Math.min(150, mil));
      pro = Math.max(0, Math.min(150, pro));
      sta = Math.max(0, Math.min(150, sta));

      // population
      let popMax = Math.floor(
        (pro / 100) * config.globalSettings.defaultRanges.population.max * settlementType.populationMultiplier
      );
      if (settlementType.name === "Station" && Math.random() < 0.95) {
        popMax = Math.min(popMax, 200);
      }
      popMax = Math.max(popMax, config.globalSettings.defaultRanges.population.min);
      let population = randomInt(config.globalSettings.defaultRanges.population.min, popMax);

      // Government
      let govChoice = weightedRandomBaseWeight(config.settlement.government.types);
      let governmentName = govChoice.name; // e.g. "Elected Governor"

      // Ruler Title
      let rulerChoice = weightedRandomBaseWeight(config.settlement.government.rulerTitles);
      let rulerTitle = rulerChoice.title; // e.g. "Commander"

      // Important Figure
      let firstPre = weightedRandom(config.names.firstNamePrefixes).name;
      let firstSuf = weightedRandom(config.names.firstNameSuffixes).name;
      let lastPre  = weightedRandom(config.names.lastNamePrefixes).name;
      let lastSuf  = weightedRandom(config.names.lastNameSuffixes).name;
      let importantFigure = rulerTitle + " " + firstPre + firstSuf + " " + lastPre + lastSuf;

      // exports
      let exportsPool;
      if (pro < 40) {
        exportsPool = [...config.settlement.attributes.exports.lowProsperity];
      } else if (pro < 70) {
        exportsPool = [...config.settlement.attributes.exports.mediumProsperity];
      } else {
        exportsPool = [...config.settlement.attributes.exports.highProsperity];
      }
      exportsPool.sort(() => Math.random() - 0.5);
      let expCount = randomInt(1,5);
      let exportsArr = exportsPool.slice(0, expCount);

      // POI
      let poiPool;
      if (pro < 40) {
        poiPool = [...config.settlement.attributes.pointsOfInterest.lowProsperity];
      } else if (pro < 70) {
        poiPool = [...config.settlement.attributes.pointsOfInterest.mediumProsperity];
      } else {
        poiPool = [...config.settlement.attributes.pointsOfInterest.highProsperity];
      }
      poiPool.sort(() => Math.random() - 0.5);
      let poiCount = randomInt(1, poiPool.length);
      let poi = poiPool.slice(0, poiCount);

      // conditions
      let condPool = [...config.settlement.conditions.settlement];
      condPool.sort(() => Math.random() - 0.5);
      let condCount = randomInt(0,3);
      let conditions = condPool.slice(0, condCount);

      // military
      let military = generateMilitaryData(population, mil, forceStation);

      // military structures
      let baseStructCount = randomInt(
        config.settlement.military.structures.minCount,
        config.settlement.military.structures.maxCount
      );
      if (mil > 70) baseStructCount += 2;
      else if (mil < 40) baseStructCount = Math.max(1, baseStructCount - 1);

      let structList = [...config.settlement.military.structures.structureList];
      structList.sort(() => Math.random() - 0.5);
      let militaryStructures = structList.slice(0, baseStructCount);

      // traders
      let tMin = config.settlement.traders.defaultCountRange.min;
      let tMax = config.settlement.traders.defaultCountRange.max;
      if (sta < 40) tMax = Math.max(tMin, tMax - 1);
      else if (sta > 70) tMax = Math.min(6, tMax + 1);
      let traderCount = randomInt(tMin, tMax);

      let traders = [];
      for (let i=0; i<traderCount; i++){
        let cFirstPre = weightedRandom(config.names.firstNamePrefixes).name;
        let cFirstSuf = weightedRandom(config.names.firstNameSuffixes).name;
        let cLastPre  = weightedRandom(config.names.lastNamePrefixes).name;
        let cLastSuf  = weightedRandom(config.names.lastNameSuffixes).name;
        let cName = cFirstPre + cFirstSuf + " " + cLastPre + cLastSuf;

        let matPool;
        if (pro < 40) {
          matPool = config.extensions.traders.configuration.attributes.tradedMaterial.lowProsperity;
        } else if (pro < 70) {
          matPool = config.extensions.traders.configuration.attributes.tradedMaterial.mediumProsperity;
        } else {
          matPool = config.extensions.traders.configuration.attributes.tradedMaterial.highProsperity;
        }
        let mat = matPool[randomInt(0, matPool.length -1)];
        traders.push({
          captainName: cName,
          tradedMaterial: mat
        });
      }

      return {
        name: settlementName.trim(),
        settlementType: settlementType.name,
        population,
        government: governmentName,
        importantFigure,
        coreStats: {
          militarism: mil,
          prosperity: pro,
          stability: sta
        },
        exports: exportsArr,
        pointsOfInterest: poi,
        conditions,
        military,
        militaryStructures,
        traders
      };
    }

    function generateMilitaryData(population, militarism, forcedStation) {
      let basePerc = randomInt(
        config.settlement.military.assets.soldiers.populationPercentage.min * 100,
        config.settlement.military.assets.soldiers.populationPercentage.max * 100
      ) / 100;
      let soldierMult = militarism / 50; 
      let soldiers = Math.floor(population * basePerc * soldierMult);
      soldiers = Math.min(soldiers, population);

      let ratio = randomInt(
        config.settlement.military.assets.armoredVehicles.soldiersPerVehicle.min,
        config.settlement.military.assets.armoredVehicles.soldiersPerVehicle.max
      );
      let armoredVehicles = Math.max(1, Math.floor(soldiers / ratio));

      let ships = {};
      if (config.settlement.military.assets.ships.enabled) {
        let totalShips = 0;
        if (forcedStation) {
          totalShips = randomInt(
            config.settlement.military.assets.ships.forcedStationMinimum.min,
            config.settlement.military.assets.ships.forcedStationMinimum.max
          );
        } else if (population >= config.settlement.military.assets.ships.defaultMinimumPopulation) {
          totalShips = randomInt(
            config.settlement.military.assets.ships.defaultShipCountRange.min,
            config.settlement.military.assets.ships.defaultShipCountRange.max
          );
        }
        // init
        for (let st of config.settlement.military.assets.ships.shipTypes) {
          ships[st.name] = 0;
        }
        for (let i=0; i<totalShips; i++){
          let chosenType = weightedRandom(config.settlement.military.assets.ships.shipTypes);
          ships[chosenType.name]++;
        }
      }
      return { soldiers, armoredVehicles, ships };
    }

    // --------------------
    // Rendering
    // --------------------
    function renderSettlement(settlement, planetIndex, settlementIndex) {
      // Prepare ships as a string
      let shipStr = "None";
      let shipObj = settlement.military.ships;
      if (shipObj) {
        let arr = [];
        for (let s in shipObj) {
          if (shipObj[s] > 0) arr.push(`${s} x${shipObj[s]}`);
        }
        if (arr.length > 0) {
          shipStr = arr.join(", ");
        }
      }

      // Format traders
      let tradersStr = "None";
      if (settlement.traders && settlement.traders.length>0) {
        let tArr = settlement.traders.map(t => `${t.captainName} (${t.tradedMaterial})`);
        tradersStr = tArr.join(", ");
      }

      // Format military structures
      let milStructs = settlement.militaryStructures.length > 0
                       ? settlement.militaryStructures.join(", ")
                       : "None";

      return `
      <div class="settlement">
        <div class="settlement-output">
          <p><strong>Name:</strong> ${settlement.name}</p>
          <p><strong>Type:</strong> ${settlement.settlementType}</p>
          <p><strong>Population:</strong> ${settlement.population}</p>
          <p><strong>Government:</strong> ${settlement.government}</p>
          <p><strong>Important Figure:</strong> ${settlement.importantFigure}</p>
          <p><strong>Core Stats:</strong> 
             Militarism: ${settlement.coreStats.militarism}, 
             Prosperity: ${settlement.coreStats.prosperity}, 
             Stability: ${settlement.coreStats.stability}
          </p>
          <p><strong>Exports:</strong> ${settlement.exports.join(", ") || "None"}</p>
          <p><strong>Points of Interest:</strong> ${settlement.pointsOfInterest.join(", ") || "None"}</p>
          <p><strong>Conditions:</strong> ${settlement.conditions.join(", ") || "None"}</p>
          <p><strong>Military:</strong> 
             Soldiers: ${settlement.military.soldiers}, 
             Armored Vehicles: ${settlement.military.armoredVehicles}, 
             Ships: ${shipStr}
          </p>
          <p><strong>Military Structures:</strong> ${milStructs}</p>
          <p><strong>Traders:</strong> ${tradersStr}</p>
        </div>
        <button onclick="regenerateSettlement(${planetIndex}, ${settlementIndex})" 
                class="${config.ui.elements.regenerateButton.class}">
          ${config.ui.elements.regenerateButton.label}
        </button>
      </div>`;
    }

    function renderSystem() {
      const out = document.getElementById("systemOutput");
      let totalSettlements = 0;
      if (systemData.planets.length>0) {
        totalSettlements = systemData.planets.reduce((sum,pl)=> sum+pl.settlements.length, 0);
      } else {
        totalSettlements = systemData.settlements.length;
      }

      let html = `
      <div class="section">
        <h2>System: ${systemData.systemName}</h2>
        <p><strong>System Conditions:</strong> ${systemData.sysConditions.join(", ") || "None"}</p>
        <p><strong>Number of Planets:</strong> ${systemData.planets.length}</p>
        <p><strong>Total Settlements:</strong> ${totalSettlements}</p>
      </div>`;

      if (systemData.planets.length>0) {
        systemData.planets.forEach((planet, pIndex)=>{
          html += `<div class="section planet">
            <h3>Planet: ${planet.name}</h3>
            <p><strong>Biome:</strong> ${planet.biome} (${planet.type ? planet.type.name : "Unknown"})</p>`;

          if (planet.settlements.length>0) {
            planet.settlements.forEach((s, sIndex)=>{
              html += renderSettlement(s, pIndex, sIndex);
            });
          } else {
            html += `<p>No settlements on this planet.</p>`;
          }
          html += `</div>`;
        });
      } else {
        // single settlement if no planets
        html += `<div class="section">
          <h3>Settlement (Space Station):</h3>
          ${renderSettlement(systemData.settlements[0], 0, 0)}
        </div>`;
      }

      out.innerHTML = html;
    }

    function regenerateSettlement(planetIndex, settlementIndex) {
      if (systemData.planets && systemData.planets.length>0) {
        let planet = systemData.planets[planetIndex];
        planet.settlements[settlementIndex] = generateSettlementData(false, planet.type);
      } else {
        systemData.settlements[settlementIndex] = generateSettlementData(true);
      }
      renderSystem();
    }

    // --------------------
    // Event Listeners
    // --------------------
    document.getElementById("generateSystemButton").addEventListener("click", generateSystem);

    loadConfig().then(()=>{
      // optionally auto-generate
      // generateSystem();
    });
  </script>
</body>
</html>
